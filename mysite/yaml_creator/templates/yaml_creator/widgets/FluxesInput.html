<!DOCTYPE HTML>
<HTML>
<head>
  <meta charset="utf-8">
  <title>javascript test</title>
  <!--
  <script src="../../../static/yaml_creator/js/FluxFields.js" type="text/javascript"></script>
  -->
</head>
<h2>Fluxes</h2>
<body>
  <!--
  <input 
  	type ="{{ widget.type }}" 
  	id="fluxReturn", 
    value='{"names":["x","y","z"],"internal_fluxes":[{"source":"x","target":"y","expression":"x**3"}]}'
  >	
  	The following (hidden) input field is used for the communication between 
  	the python widget and the javascript code
  	Both write a JSON string in it
  
  -->
  	
  <input 
  	id="fluxReturn" 
  	name="{{ widget.name }}"   
  	{% if widget.value != None %} value="{{ widget.value }}"{% endif %}
  	{% include "django/forms/widgets/attrs.html" %}
  >	

  <div id="TableDiv"> </div>
  <p> 
  	tableLengthDemo: <div id="tableLengthDemo"> </div>
  </p> 
  <p> 
    <div id="AddButtonDiv"> </div> 
  </p>
  <p> 
    <div id="SubmitButtonDiv"> </div> 
  </p>
 
  // In fluxes
  <p> 
    <div id='InFluxTableDiv' ></div>
  </p>
  <p> 
    <div id='AddInFluxButtonDiv' ></div>
  </p>
  
  
  // Internal fluxes
  <p> 
    <div id='InternalFluxTableDiv' ></div>
  </p>
  <p> 
    <div id='AddInternalFluxButtonDiv' ></div>
  </p>
  
  // Out fluxes
  <p> 
    <div id='OutFluxTableDiv' ></div>
  </p>
  <p> 
    <div id='AddOutFluxButtonDiv' ></div>
  </p>

</body>
<script>

  function TableWithAddButton(names,fluxes,descriptor){
    this.fluxes=fluxes;
    this.names=names;
    var tbl = document.createElement('table');
    var thead = document.createElement("thead");

    var myBody= document.createElement("tbody")
    tbl.appendChild(myBody);
    this.table=tbl;
    this.myBody=myBody;
    
    thead.appendChild(descriptor.tr_head());
    tbl.appendChild(thead);

    var T=this;// we need this local variable in the onclick function of the button
    T.addRow=function (flux){
    	var row =descriptor.template_row(T.names,flux);
    	var bd  =document.createElement("TD");
  	  var b= document.createElement("INPUT");
      b.setAttribute('type','button');
      b.setAttribute('value','delete flux');
  	  b.onclick=function() {	
        row=this.parentElement.parentElement;
      	index=row.rowIndex;
      	T.table.deleteRow(index);
        descriptor.onchange();
      };
  
      bd.appendChild(b);
      row.appendChild(bd);
      T.myBody.appendChild(row);
    };
    this.fluxes.forEach(
      function(f){T.addRow(f)}
    )
    var default_flux=descriptor.default_flux(this.names,this.fluxes);
  	var b= document.createElement("INPUT");
    b.type='button';
    b.value=descriptor.buttonLabel;
    b.onclick=function(){
      T.addRow(default_flux);
      descriptor.onchange();
    }
    this.button=b;
    
    //////////////////////////
    this.value=function(){
      var arr=[];
      for (let row of this.myBody.rows) {
          var ff=row.ff;
          arr.push(ff.value);
  	  }
      return arr;
    }

  }
  //var arr={
  //  'names':['x','y','z'],
  //  'internal_fluxes':[
  //    {'source':'x','target':'y','expression':'x**3'},
  //    {'source':'y','target':'z','expression':'x**4'}
  //  ],
  //  'in_fluxes':[
  //    {'target':'x','expression':'x**2'},
  //    {'target':'y','expression':'x**3'},
  //    {'target':'z','expression':'x**4'}
  //  ],
  //  'out_fluxes':[
  //    {'source':'y','expression':'x**3'},
  //    {'source':'z','expression':'x**4'}
  //  ]
  //}
  arr=readHiddenTextField();
  function readHiddenTextField(){
    hf=document.getElementById('fluxReturn');
    return JSON.parse(hf.value);
  }
  function writeHiddenTextField(arr){
    console.log(arr);
    hf=document.getElementById('fluxReturn');
    hf.value=JSON.stringify(arr); 
  }
  function report_t1(){
    arr=readHiddenTextField();
    arr.in_fluxes=t1.value();
    writeHiddenTextField(arr);
  }
  function report_t2(){
    arr=readHiddenTextField();
    arr.internal_fluxes=t2.value();
    writeHiddenTextField(arr);
  }
  function report_t3(){
    arr=readHiddenTextField();
    arr.out_fluxes=t3.value();
    writeHiddenTextField(arr);
  }
  function main(){
    // input fluxes
    d_in={
      default_flux:function(names,fluxes){
        return {'target':names[0],'expression':names[0]}
      },
      tr_head:function(){
        var tr_head = document.createElement("tr");
        
        var th_target = document.createElement("th");
        var th_expression = document.createElement("th");
  
        th_target.textContent = "Target";
        th_expression.textContent = "Expression";
        
        tr_head.appendChild(th_target);
        tr_head.appendChild(th_expression);
        return tr_head;
      },
      template_row:function(names,flux){
    	  var row =document.createElement("TR");
    	  var td  =document.createElement("TD");
    	  var ed  =document.createElement("TD");
        var ff=new InFluxField(names,flux);
        ff.onchange=report_t1;
        //create a reference in each row to its 
        //FluxForm instance
        row.ff=ff;
    	  td.appendChild(ff.select1);
    	  ed.appendChild(ff.expression);
        row.appendChild(td);
        row.appendChild(ed);
        return row
      },
      onchange: report_t1, 
      buttonLabel:"add influx"
    }
    t1=new TableWithAddButton(arr.names,arr.in_fluxes,d_in); 
    d1=document.getElementById("InFluxTableDiv");	
    b1=document.getElementById("AddInFluxButtonDiv");	
    d1.appendChild(t1.table);
    b1.appendChild(t1.button);
    
    
    // internal fluxes
    d_internal={
      default_flux:function(names,fluxes){
        return {'source':names[0],'target':names[1],'expression':names[0]}
      },
      tr_head:function(){
        var tr_head = document.createElement("tr");
        
        var th_source = document.createElement("th");
        var th_target = document.createElement("th");
        var th_expression = document.createElement("th");
  
        th_source.textContent = "Source";
        th_target.textContent = "Target";
        th_expression.textContent = "Expression";
        
        tr_head.appendChild(th_source);
        tr_head.appendChild(th_target);
        tr_head.appendChild(th_expression);
        return tr_head;
      },
      template_row:function(names,flux){
    	  var row =document.createElement("TR");
    	  var sd  =document.createElement("TD");
    	  var td  =document.createElement("TD");
    	  var ed  =document.createElement("TD");
        var ff=new InternalFluxField(names,flux);
        ff.onchange=report_t2;
        //create a reference in each row to its 
        //FluxForm instande
        row.ff=ff;
    	  sd.appendChild(ff.select1);
    	  td.appendChild(ff.select2);
    	  ed.appendChild(ff.expression);
        row.appendChild(sd);
        row.appendChild(td);
        row.appendChild(ed);
        return row
      },
      onchange: report_t2, 
      buttonLabel:"add internal flux"
    }
    t2=new TableWithAddButton(arr.names,arr.internal_fluxes,d_internal); 
    d2=document.getElementById("InternalFluxTableDiv");	
    b2=document.getElementById("AddInternalFluxButtonDiv");	
    d2.appendChild(t2.table);
    b2.appendChild(t2.button);
    d_out={
      default_flux:function(names,fluxes){
        return {'source':names[0],'expression':names[0]};
      },
      tr_head:function(){
        var tr_head = document.createElement("tr");
        
        var th_source= document.createElement("th");
        var th_expression = document.createElement("th");
  
        th_source.textContent = "Source";
        th_expression.textContent = "Expression";
        
        tr_head.appendChild(th_source);
        tr_head.appendChild(th_expression);
        return tr_head;
      },
      template_row:function(names,flux){
    	  var row =document.createElement("TR");
    	  var td  =document.createElement("TD");
    	  var ed  =document.createElement("TD");
        var ff=new OutFluxField(names,flux);
        ff.onchange=report_t3;
        //create a reference in each row to its 
        //FluxForm instande
        row.ff=ff;
    	  td.appendChild(ff.select1);
    	  ed.appendChild(ff.expression);
        row.appendChild(td);
        row.appendChild(ed);
        return row
      },
      onchange:report_t3,
      buttonLabel:"add outflux"
    }
    t3=new TableWithAddButton(arr.names,arr.out_fluxes,d_out); 
    d3=document.getElementById("OutFluxTableDiv");	
    b3=document.getElementById("AddOutFluxButtonDiv");	
    d3.appendChild(t3.table);
    b3.appendChild(t3.button);
  };
  document.onload=main();

</script>
