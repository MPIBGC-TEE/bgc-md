<!DOCTYPE html>
<html lang="en-US" >
<head >
  <meta charset="utf-8">

  <meta http-equiv="X-UA-Compatible" content="IE=Edge">
<body> 
  The purpose of the prototype is to 
  show how to accidentally mix up table elements 
  <div id='InFluxTableDiv' ></div>
  <div id='AddInFluxButtonDiv' ></div>
  <div id='InternalFluxTableDiv' ></div>
  <div id='AddInternalFluxButtonDiv' ></div>
</body> 
<script>
  
  function TableWithAddButton(names,fluxes,descriptor){
    var tbl = document.createElement('table');
    var thead = document.createElement("thead");
    var myBody= document.createElement("tbody")

    tbl.appendChild(myBody);
    this.fluxes=fluxes;
    this.names=names;
    this.table=tbl;
    this.myBody=myBody;
    var tr_head = descriptor.tr_head();
    

    var T=this;// we need this local variable in the onclick function of the button
    this.addRow=function (names,flux){
    	var row =descriptor.template_row(names,flux);
    	var bd  =document.createElement("TD");
  	  var b= document.createElement("INPUT");
      b.setAttribute('type','button');
      b.setAttribute('value','delete flux');
  	  b.onclick=function() {	
        row=this.parentElement.parentElement;
      	index=row.rowIndex;
      	T.table.deleteRow(index);
        descriptor.onchange();
        console.log(index);
      };
  
      bd.appendChild(b);
      row.appendChild(bd);
      myBody.appendChild(row);
      //T.myBody.appendChild(row);
    };
    this.fluxes.forEach(
      function(f){T.addRow(f)}
    )
    var default_flux=descriptor.default_flux(names,fluxes);
  	var b= document.createElement("INPUT");
    b.type='button';
    b.value='add Influx';
    b.onclick=function(){
      T.addRow(default_flux);
      descriptor.onchange();
    }
    this.button=b;
    this.value=function(){
      var tbody=this.table.tBodies[0];
      //console.log(tbody);
      console.log(tbody.rows);
      var arr=[];
      
      for (let row of tbody.rows) {
          var cells=row.cells;
          var txtn=cells[0].childNodes[0]
          console.log(txtn);
        arr.push({source:txtn});
  	  }
      console.log(arr);
      return arr;
    }

  }
  var arr={
    'names':['x','y','z'],
    'internal_fluxes':[
      {'source':'x','target':'y','expression':'x**3'},
      {'source':'y','target':'z','expression':'x**4'}
    ],
    'in_fluxes':[
      {'target':'x','expression':'x**2'},
      {'target':'y','expression':'x**3'},
      {'target':'z','expression':'x**4'}
    ],
    'out_fluxes':[
      {'source':'y','expression':'x**3'},
      {'source':'z','expression':'x**4'}
    ]
  }
  function main(){
    // input fluxes
    d_in={
      default_flux:function(names,fluxes){
        return {'target':names[0]}
      },
      tr_head:function(){
        var tr_head = document.createElement("tr");
        
        var th_target = document.createElement("th");
        var th_expression = document.createElement("th");
  
        th_target.textContent = "Target";
        th_expression.textContent = "Expression";
        
        tr_head.appendChild(th_target);
        tr_head.appendChild(th_expression);
        return tr_head;
      },
      template_row:function(flux){
    	  var row =document.createElement("TR");
    	  var sd  =document.createElement("TD");
    	  var target=document.createTextNode(flux.target);
    	  sd.appendChild(target);
        row.appendChild(sd);
        return row
      },
      onchange: function (){
          //fake the array at the moment
          //arr=readHiddenTextField();
          arr.internal_fluxes=t1.value();
          console.log(arr);
          //s=JSON.stringify(arr); 
          //ret.value=s;
          //console.log(ret.value);
      }
    }
    t1=new TableWithAddButton(arr.names,arr.in_fluxes,d_in); 
    d1=document.getElementById("InFluxTableDiv");	
    b1=document.getElementById("AddInFluxButtonDiv");	
    d1.appendChild(t1.table);
    b1.appendChild(t1.button);
    // internal fluxes
    d_internal={
      default_flux:function(names,fluxes){
        return {'source':names[0],'target':names[1]}
      },
      tr_head:function(){
        var tr_head = document.createElement("tr");
        
        var th_source = document.createElement("th");
        var th_target = document.createElement("th");
        var th_expression = document.createElement("th");
  
        th_source.textContent = "Source";
        th_target.textContent = "Target";
        th_expression.textContent = "Expression";
        
        tr_head.appendChild(th_source);
        tr_head.appendChild(th_target);
        tr_head.appendChild(th_expression);
        return tr_head;
      },
      template_row:function(flux){
    	  var row =document.createElement("TR");
    	  var sd  =document.createElement("TD");
    	  var td  =document.createElement("TD");
    	  var source=document.createTextNode(flux.source);
    	  var target=document.createTextNode(flux.target);
    	  sd.appendChild(source);
    	  td.appendChild(target);
        row.appendChild(sd);
        row.appendChild(td);
        return row
      },
      onchange: function (){
          //fake the array at the moment
          //arr=readHiddenTextField();
          arr.internal_fluxes=t2.value();
          console.log(arr);
          //s=JSON.stringify(arr); 
          //ret.value=s;
          //console.log(ret.value);
      }
    }
    t2=new TableWithAddButton(arr.names,arr.internal_fluxes,d_internal); 
    d2=document.getElementById("InternalFluxTableDiv");	
    b2=document.getElementById("AddInternalFluxButtonDiv");	
    d2.appendChild(t2.table);
    b2.appendChild(t2.button);
  };
  document.onload=main();
  </script>
</html>
